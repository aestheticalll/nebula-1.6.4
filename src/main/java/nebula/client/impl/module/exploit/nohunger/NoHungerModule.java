package nebula.client.impl.module.exploit.nohunger;

import nebula.client.api.eventbus.Listener;
import nebula.client.api.eventbus.Subscribe;
import nebula.client.impl.event.EventStage;
import nebula.client.impl.event.net.EventPacket;
import nebula.client.impl.event.player.EventMoveUpdate;
import nebula.client.impl.event.player.EventUpdate;
import nebula.client.api.module.Module;
import nebula.client.api.module.ModuleMeta;
import net.minecraft.network.play.client.C0BPacketEntityAction;

/**
 * @author Gavin
 * @since 08/18/23
 */
@SuppressWarnings("unused")
@ModuleMeta(name = "NoHunger",
    description = "Prevents server-side hunger loss")
public class NoHungerModule extends Module
{

  @Subscribe
  private final Listener<EventPacket.Out> packetOut = event ->
  {
    if (event.packet() instanceof C0BPacketEntityAction packet)
    {
      int action = packet.getAction();
      if (action == 4 || action == 5) event.setCanceled(true);
    }
  };
  @Subscribe
  private final Listener<EventMoveUpdate> moveUpdate = event ->
  {
    if (event.stage() == EventStage.PRE)
    {
      event.setGround(true);
    }
  };
  private boolean sentStopSprint;
  @Subscribe
  private final Listener<EventUpdate> update = event ->
  {
    if (mc.thePlayer.ticksExisted < 5)
    {
      sentStopSprint = false;
      return;
    }

    if (!sentStopSprint && mc.thePlayer.isSprinting())
    {
      sentStopSprint = true;
      mc.thePlayer.sendQueue.addToSendQueueSilent(new C0BPacketEntityAction(
          mc.thePlayer, 5));
    }
  };

  @Override
  public void disable()
  {
    super.disable();
    sentStopSprint = false;
  }
}
