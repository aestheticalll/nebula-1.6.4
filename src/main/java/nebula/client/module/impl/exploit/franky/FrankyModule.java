package nebula.client.module.impl.exploit.franky;

import nebula.client.Nebula;
import nebula.client.listener.bus.Listener;
import nebula.client.listener.bus.Subscribe;
import nebula.client.listener.event.player.EventUpdate;
import nebula.client.module.Module;
import nebula.client.module.ModuleMeta;
import nebula.client.module.impl.movement.speed.SpeedModule;
import nebula.client.module.impl.render.hud.HUDModule;
import nebula.client.util.math.AngleUtils;
import net.minecraft.client.renderer.entity.RenderManager;
import net.minecraft.entity.Entity;
import net.minecraft.entity.monster.EntityEnderman;

import java.util.Comparator;
import java.util.List;

@ModuleMeta(name = "Franky")
public class FrankyModule extends Module {

  @Subscribe
  private final Listener<EventUpdate> updateListener = event -> {

    EntityEnderman target = (EntityEnderman) ((List<Entity>) mc.theWorld.loadedEntityList)
        .stream()
        .filter((x) -> x instanceof EntityEnderman && mc.thePlayer.getDistanceToEntity(x) < 50 && mc.thePlayer.canEntityBeSeen(x))
        .min(Comparator.comparingDouble((x) -> mc.thePlayer.getDistanceToEntity(x)))
        .orElse(null);

    RenderManager.field_85095_o = true;

    if (target != null) {
      for (Module module : Nebula.INSTANCE.module.values()) {
        if (!(module instanceof HUDModule || module instanceof FrankyModule)) {

          if (module instanceof SpeedModule && !module.macro().toggled()) {
            module.macro().setEnabled(true);
            continue;
          }

          if ( module.macro().toggled()){
            module.macro().setEnabled(false);
          }

        }
      }

      if (mc.currentScreen != null) {
        mc.displayGuiScreen(null);
      }

      final float[] angles = AngleUtils.entity(target);
      mc.thePlayer.rotationYaw = angles[0];
      mc.thePlayer.rotationPitch = angles[1];

      if (target.getDistanceToEntity(mc.thePlayer) < 3.5) {
        mc.thePlayer.swingItem();
        mc.playerController.attackEntity(mc.thePlayer, target);
      }

      mc.gameSettings.keyBindForward.pressed = true;
    } else {
      //mc.gameSettings.keyBindForward.pressed = false;
    }
  };
}
